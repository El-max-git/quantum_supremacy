<div class="container" style="padding: 2rem 1rem;">
    <!-- Back Button -->
    <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
        <button class="back-to-list-btn" id="back-to-articles">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É
        </button>
    </div>

    <div class="article-wrapper">
        <!-- Article Content -->
        <article class="article-content" id="article-content">
            <!-- Article Header -->
            <header class="article-header">
                <div class="article-category" id="article-category"></div>
                <h1 class="article-title" id="article-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <div class="article-meta">
                    <span class="article-author" id="article-author"></span>
                    <span class="article-date" id="article-date"></span>
                    <span class="article-reading-time" id="article-reading-time"></span>
                </div>
                <div class="article-tags" id="article-tags"></div>
            </header>
            
            <!-- Article Body -->
            <div class="article-body" id="article-body">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏...</p>
                </div>
            </div>
        </article>
    </div>
</div>

<!-- Floating Navigation Buttons -->
<div class="article-scroll-buttons" id="article-scroll-buttons">
    <button class="scroll-btn scroll-btn-top" id="scroll-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞" title="–ù–∞–≤–µ—Ä—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>
    <button class="scroll-btn scroll-btn-bottom" id="scroll-to-bottom" aria-label="–í–Ω–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞" title="–í–Ω–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9l6 6 6-6"/>
        </svg>
    </button>
    <button class="scroll-btn scroll-btn-left" id="scroll-to-prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
    </button>
    <button class="scroll-btn scroll-btn-right" id="scroll-to-next" aria-label="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" title="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18l6-6-6-6"/>
        </svg>
    </button>
    <button class="scroll-btn scroll-btn-home" id="scroll-to-home" aria-label="–ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
    </button>
</div>

<!-- Article Viewer Script -->
<script>
(function() {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Å—Ç–∞—Ç—å–∏ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–¥–ª—è SPA –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
    function getArticleId() {
        let articleId = null;
        
        // –ú–µ—Ç–æ–¥ 1: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ window.location.search (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
        if (window.location.search) {
            const urlParams = new URLSearchParams(window.location.search);
            articleId = urlParams.get('id');
        }
        
        // –ú–µ—Ç–æ–¥ 2: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ router.currentRoute (–¥–ª—è SPA –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
        if (!articleId && window.router && window.router.currentRoute) {
            const routeUrl = window.router.currentRoute;
            if (routeUrl.includes('?')) {
                try {
                    const queryPart = routeUrl.split('?')[1];
                    const routeParams = new URLSearchParams(queryPart);
                    articleId = routeParams.get('id');
                } catch (e) {
                    console.error('[ArticleView] Error parsing router.currentRoute:', e);
                }
            }
        }
        
        // –ú–µ—Ç–æ–¥ 3: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ window.location.href –Ω–∞–ø—Ä—è–º—É—é
        if (!articleId) {
            const fullUrl = window.location.href;
            if (fullUrl.includes('?')) {
                try {
                    const queryPart = fullUrl.split('?')[1].split('#')[0]; // –£–±–∏—Ä–∞–µ–º —Ö–µ—à, –µ—Å–ª–∏ –µ—Å—Ç—å
                    const hrefParams = new URLSearchParams(queryPart);
                    articleId = hrefParams.get('id');
                } catch (e) {
                    console.error('[ArticleView] Error parsing window.location.href:', e);
                }
            }
        }
        
        // –ú–µ—Ç–æ–¥ 4: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ pathname, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ª—É—á–∞–π)
        if (!articleId && window.location.pathname.includes('/article/')) {
            const pathParts = window.location.pathname.split('/article/');
            if (pathParts.length > 1) {
                articleId = pathParts[1].split('?')[0].split('#')[0];
            }
        }
        
        // –ú–µ—Ç–æ–¥ 5: –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –ø–∞—Ä—Å–∏–º —Ö–µ—à, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (!articleId && window.location.hash) {
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('id=')) {
                articleId = hash.substring(3).split('&')[0];
            }
        }
        
        return articleId;
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏
    async function loadArticle(articleId) {
        if (!articleId) {
            console.error('[ArticleView] No articleId provided');
            const errorHtml = `
                <div class="article-error">
                    <h2>‚ùå –°—Ç–∞—Ç—å—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞</h2>
                    <p>–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—Ç–∞—Ç—å–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        URL: ${window.location.href}
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Search: ${window.location.search}
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Router: ${window.router ? 'exists' : 'not found'}
                    </p>
                    ${window.router?.currentRoute ? `<p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">Current Route: ${window.router.currentRoute}</p>` : ''}
                </div>
            `;
            const bodyEl = document.getElementById('article-body');
            if (bodyEl) {
                bodyEl.innerHTML = errorHtml;
            } else {
                console.error('[ArticleView] article-body element not found!');
            }
            return;
        }
    
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º basePath —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤ router.js
        let basePath = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º pathname - –µ—Å–ª–∏ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /quantum_supremacy, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ GitHub Pages
        const pathname = window.location.pathname;
        const hostname = window.location.hostname;
        const isPathGitHubPages = pathname.startsWith('/quantum_supremacy');
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || 
                          hostname.startsWith('192.168.') || hostname.startsWith('10.') || 
                          hostname.startsWith('172.') || hostname === '' ||
                          /^\d+\.\d+\.\d+\.\d+$/.test(hostname); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ IP –∞–¥—Ä–µ—Å
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º basePath —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: isLocalhost > pathname > hostname
        if (isLocalhost) {
            // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ - basePath –í–°–ï–ì–î–ê –ø—É—Å—Ç–æ–π, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç router.basePath
            basePath = '';
        } else if (window.router && window.router.basePath !== undefined) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º basePath –∏–∑ router, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ localhost
            if (isPathGitHubPages && !window.router.basePath) {
                // –ï—Å–ª–∏ pathname —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ GitHub Pages, –Ω–æ router.basePath –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º pathname
                basePath = '/quantum_supremacy';
            } else {
                basePath = window.router.basePath || '';
            }
        } else {
            // –ï—Å–ª–∏ router –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∞–º–∏
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: pathname > hostname
            if (isPathGitHubPages) {
                basePath = '/quantum_supremacy';
            } else if (hostname.includes('github.io') && !isLocalhost) {
                basePath = '/quantum_supremacy';
            } else {
                // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ basePath –ø—É—Å—Ç–æ–π
                basePath = '';
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —Å—Ç–∞—Ç–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç–∞—Ç—å–∏
        const catalogUrl = `${basePath}/articles/articles-list.json`;
        const catalogResponse = await fetch(catalogUrl, { cache: 'no-store' });
        if (!catalogResponse.ok) {
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Å—Ç–∞—Ç–µ–π: ${catalogResponse.status} ${catalogResponse.statusText}`);
        }
        
        const catalog = await catalogResponse.json();
        
        // –ò—â–µ–º —Å—Ç–∞—Ç—å—é –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        function findArticle(items, targetId) {
            for (const item of items) {
                if (item.id === targetId && item.mdFile) {
                    return item;
                }
                if (item.items) {
                    const found = findArticle(item.items, targetId);
                    if (found) return found;
                }
            }
            return null;
        }
        
        const article = findArticle(catalog.categories || [], articleId);
        
        if (!article) {
            console.error('[ArticleView] Article not found in catalog. Available IDs:', 
                catalog.categories?.flatMap(cat => cat.items?.map(i => i.id) || []) || []);
            throw new Error(`–°—Ç–∞—Ç—å—è —Å ID "${articleId}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ`);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º markdown —Ñ–∞–π–ª
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å: —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–ª—ç—à–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç—å
        let mdFile = article.mdFile.startsWith('/') ? article.mdFile.substring(1) : article.mdFile;
        
        // –ù–ï –∫–æ–¥–∏—Ä—É–µ–º –ø—É—Ç—å - —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–º–µ—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è–º–∏ –∏ –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
        // –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ 404, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ—Ç —Ñ–∞–π–ª –ø–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏
        // –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        
        let mdUrl = basePath 
            ? `${basePath}/${mdFile}`.replace(/([^:]\/)\/+/g, '$1')
            : `/${mdFile}`.replace(/\/+/g, '/');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Å—Å–∏–≤ URL-–æ–≤ –¥–ª—è –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        // –ü–†–ò–û–†–ò–¢–ï–¢: GitHub Raw URL (main) - —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è GitHub Pages
        let possibleUrls = [];
        
        // –ü–ï–†–í–´–ô –ü–†–ò–û–†–ò–¢–ï–¢ - GitHub Raw URL (—Å–∞–º—ã–π —É—Å–ø–µ—à–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è GitHub Pages)
        // –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–µ –ø—É—Ç–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ GitHub Pages
        if (hostname.includes('github.io')) {
            // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ hostname
            // el-max-git.github.io -> username = el-max-git
            const repoMatch = hostname.match(/^([^.]+)\.github\.io$/);
            
            if (repoMatch) {
                const username = repoMatch[1];
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –∏–∑ mdFile –Ω–∞–ø—Ä—è–º—É—é
                // main - —Å–∞–º–∞—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–∞—è –≤–µ—Ç–∫–∞, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤–æ–π
                const mainRawUrl = `https://raw.githubusercontent.com/${username}/quantum_supremacy/main/${mdFile}`;
                possibleUrls.push(mainRawUrl);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–µ –≤–µ—Ç–∫–∏ –ø–æ—Å–ª–µ main
                const otherBranches = ['master', 'gh-pages'];
                for (const branch of otherBranches) {
                    const rawUrl = `https://raw.githubusercontent.com/${username}/quantum_supremacy/${branch}/${mdFile}`;
                    if (!possibleUrls.includes(rawUrl)) {
                        possibleUrls.push(rawUrl);
                    }
                }
            }
        }
        
        // –í–¢–û–†–û–ô –ü–†–ò–û–†–ò–¢–ï–¢ - –æ–±—ã—á–Ω—ã–µ –ø—É—Ç–∏ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–∞–π–ª —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ GitHub Pages)
        // –ü–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –∫–∞–∫ –µ—Å—Ç—å (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—É—Ç—å)
        possibleUrls.push(mdUrl);
        
        // –í—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä (–¥–ª—è Windows-—Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ GitHub Pages)
        const lowerUrl = mdUrl.toLowerCase();
        if (lowerUrl !== mdUrl && !possibleUrls.includes(lowerUrl)) {
            possibleUrls.push(lowerUrl);
        }
        
        // –¢—Ä–µ—Ç–∏–π –≤–∞—Ä–∏–∞–Ω—Ç - –±–µ–∑ basePath (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é)
        if (basePath && mdUrl.startsWith(basePath)) {
            const urlWithoutBasePath = mdUrl.substring(basePath.length);
            if (urlWithoutBasePath && !possibleUrls.includes(urlWithoutBasePath)) {
                possibleUrls.push(urlWithoutBasePath);
            }
        }
        
        // –ß–µ—Ç–≤–µ—Ä—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è (–±–µ–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–ª—ç—à–∞)
        const relativeUrl = mdUrl.startsWith('/') ? mdUrl.substring(1) : mdUrl;
        if (relativeUrl && !possibleUrls.includes(relativeUrl) && relativeUrl !== mdUrl) {
            possibleUrls.push(relativeUrl);
        }
        
        let mdResponse = null;
        let lastError = null;
        let triedUrl = null;
        let successUrl = null;
        
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –ø–æ —Ä–∞–∑–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –ø—É—Ç–∏
        for (let i = 0; i < possibleUrls.length; i++) {
            const tryUrl = possibleUrls[i];
            triedUrl = tryUrl;
            
            try {
                // –î–ª—è GitHub Raw URL –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è CORS
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö URL (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö) mode –º–æ–∂–µ—Ç –±—ã—Ç—å 'same-origin'
                const isExternalUrl = tryUrl.startsWith('http://') || tryUrl.startsWith('https://');
                const fetchOptions = { 
                    cache: 'no-store',
                    mode: isExternalUrl ? 'cors' : 'same-origin' // CORS –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö URL (raw.githubusercontent.com)
                };
                
                mdResponse = await fetch(tryUrl, fetchOptions);
                
                if (mdResponse.ok) {
                    successUrl = tryUrl;
                    break; // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                } else if (mdResponse.status === 404) {
                    // 404 - —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
                    const errorText = await mdResponse.text().catch(() => '');
                    lastError = `404 Not Found: ${tryUrl}. ${errorText.substring(0, 100)}`;
                    continue;
                } else {
                    // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
                    const errorText = await mdResponse.text().catch(() => '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏');
                    console.error('[ArticleView] Response error:', errorText);
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å—Ç–∞—Ç—å–∏: ${article.mdFile} (${mdResponse.status} ${mdResponse.statusText}). URL: ${tryUrl}. Error: ${errorText.substring(0, 200)}`);
                }
            } catch (fetchError) {
                lastError = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${fetchError.message}. URL: ${tryUrl}`;
                // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π
                if (i === possibleUrls.length - 1) {
                    // –≠—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
                    throw new Error(lastError);
                }
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
                continue;
            }
        }
        
        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
        if (!mdResponse || !mdResponse.ok) {
            const triedUrlsStr = Array.isArray(possibleUrls) ? possibleUrls.join(', ') : 'unknown';
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å—Ç–∞—Ç—å–∏: ${article.mdFile}. –ü–æ–ø—Ä–æ–±–æ–≤–∞–Ω—ã URL: ${triedUrlsStr}. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${lastError || 'Unknown error'}`);
        }
        
        // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Ñ–∞–π–ª
        
        let mdText;
        try {
            mdText = await mdResponse.text();
            if (mdText.length === 0) {
                throw new Error('–§–∞–π–ª —Å—Ç–∞—Ç—å–∏ –ø—É—Å—Ç');
            }
        } catch (textError) {
            console.error('[ArticleView] Text parsing error:', textError);
            throw new Error(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞: ${textError.message}`);
        }
        
        // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ frontmatter (YAML –º–µ–∂–¥—É ---)
        let content = mdText;
        let metadata = {};
        
        const frontmatterMatch = mdText.match(/^---\r?\n([\s\S]*?)\r?\n---(\r?\n|$)/);
        if (frontmatterMatch) {
            const yamlText = frontmatterMatch[1];
            content = mdText.substring(frontmatterMatch[0].length);
            
            // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä YAML
            yamlText.split('\n').forEach(line => {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) return;
                
                const colonIndex = trimmed.indexOf(':');
                if (colonIndex === -1) return;
                
                const key = trimmed.substring(0, colonIndex).trim();
                let value = trimmed.substring(colonIndex + 1).trim();
                
                // –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
                if ((value.startsWith('"') && value.endsWith('"')) ||
                    (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.substring(1, value.length - 1);
                }
                
                // –ü–∞—Ä—Å–∏–º –º–∞—Å—Å–∏–≤—ã
                if (value.startsWith('[') && value.endsWith(']')) {
                    value = value.substring(1, value.length - 1)
                        .split(',')
                        .map(item => item.trim().replace(/^["']|["']$/g, ''));
                }
                
                metadata[key] = value;
            });
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        document.getElementById('article-title').textContent = metadata.title || articleId;
        document.getElementById('article-category').textContent = metadata.category || '–°—Ç–∞—Ç—å—è';
        document.getElementById('article-author').textContent = metadata.author || '';
        document.getElementById('article-date').textContent = metadata.date || '';
        
        if (metadata.readingTime) {
            document.getElementById('article-reading-time').textContent = `${metadata.readingTime} –º–∏–Ω —á—Ç–µ–Ω–∏—è`;
        }
        
        if (metadata.tags && metadata.tags.length) {
            const tagsHtml = metadata.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            document.getElementById('article-tags').innerHTML = tagsHtml;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º markdown –∫–∞–∫ –µ—Å—Ç—å (–±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞, —Ç–∞–∫ –∫–∞–∫ –ø–∞—Ä—Å–µ—Ä —É–¥–∞–ª–µ–Ω)
        // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π markdown –ø–∞—Ä—Å–µ—Ä –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ pre
        const escapedContent = content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä—É—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–∑ markdown (–µ—Å–ª–∏ –µ—Å—Ç—å)
        let manualToc = null;
        let articleContent = content;
        
        // –ò—â–µ–º —Ä–∞–∑–¥–µ–ª "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å —ç–º–æ–¥–∑–∏ –∏–ª–∏ –±–µ–∑)
        // –§–æ—Ä–º–∞—Ç: ## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ ... ---
        const tocHeaderPattern = /^##\s*[üìë]?\s*–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ\s*\n/;
        const tocMatch = content.match(tocHeaderPattern);
        
        if (tocMatch) {
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            const tocStart = tocMatch.index + tocMatch[0].length;
            // –ò—â–µ–º –∫–æ–Ω–µ—Ü —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ---)
            const tocEndMatch = content.substring(tocStart).match(/^\n---\n/);
            const tocEnd = tocEndMatch ? tocStart + tocEndMatch.index : content.length;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
            const tocContent = content.substring(tocStart, tocEnd).trim();
            
            if (tocContent) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ HTML
                let tocHtml = simpleMarkdownToHtml(tocContent);
                
                // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∫ —Å—Å—ã–ª–∫–∞–º –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è —Å–æ —Å—Ç–∏–ª—è–º–∏
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                const tempTocDiv = document.createElement('div');
                tempTocDiv.innerHTML = tocHtml;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å toc-link –∫–æ –≤—Å–µ–º —Å—Å—ã–ª–∫–∞–º
                const links = tempTocDiv.querySelectorAll('a');
                links.forEach(link => {
                    link.classList.add('toc-link');
                    // –î–æ–±–∞–≤–ª—è–µ–º data-toc-target –∏–∑ href –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        link.setAttribute('data-toc-target', href.substring(1));
                    }
                });
                
                manualToc = tempTocDiv.innerHTML;
                
                // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
                const tocSectionEnd = tocEndMatch ? tocEnd + tocEndMatch[0].length : content.length;
                articleContent = content.substring(0, tocMatch.index).trim() + 
                                (tocSectionEnd < content.length ? '\n\n' + content.substring(tocSectionEnd).trim() : '');
            }
        }
        
        // –ü—Ä–æ—Å—Ç–æ–π markdown –ø–∞—Ä—Å–∏–Ω–≥ (–±–∞–∑–æ–≤—ã–π)
        const html = simpleMarkdownToHtml(articleContent);
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ID –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π TOC
        const tempDivForIds = document.createElement('div');
        tempDivForIds.innerHTML = html;
        
        // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–æ –≤—Å–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        const tempHeadings = tempDivForIds.querySelectorAll('h1, h2, h3, h4, h5, h6');
        let tempIndex = 0;
        tempHeadings.forEach(heading => {
            if (!heading.id) {
                const text = heading.textContent.trim();
                const id = generateHeadingId(text, tempIndex);
                heading.id = id;
                tempIndex++;
            }
        });
        
        // –ü–æ–ª—É—á–∞–µ–º HTML —Å ID
        const htmlWithIds = tempDivForIds.innerHTML;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –î–û –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É–∂–µ –∏–º–µ—é—Ç ID)
        let tocHtml = '';
        if (manualToc) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–∑ markdown
            tocHtml = manualToc;
        } else if (typeof TableOfContents !== 'undefined') {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TOC –∏–∑ HTML —Å ID
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlWithIds;
            const toc = new TableOfContents({ minHeadings: 2 });
            
            // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ generateId, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é
            const originalGenerateId = toc.generateId.bind(toc);
            toc.generateId = function(text, index) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é generateHeadingId –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
                return generateHeadingId(text, index);
            };
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TOC (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ID –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
            tocHtml = toc.generate(tempDiv);
        }
        
        // –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç–∞—Ç—å—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º HTML —Å ID)
        const paginatedHtml = paginateArticle(htmlWithIds, tocHtml, articleId);
        
        document.getElementById('article-body').innerHTML = paginatedHtml;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MathJax –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ LaTeX —Ñ–æ—Ä–º—É–ª
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ MathJax –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
        const renderMathJax = () => {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise().catch((err) => {
                    console.warn('MathJax typeset error:', err);
                });
            } else {
                // MathJax –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(renderMathJax, 100);
            }
        };
        renderMathJax();
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–¥–æ–±–∞–≤–ª—è–µ–º ID –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
        // –í–∞–∂–Ω–æ: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –í–°–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (–¥–∞–∂–µ —Å–∫—Ä—ã—Ç—ã—Ö)
        addIdsToHeadings();
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–º–µ—é—Ç ID
        // –≠—Ç–æ –Ω—É–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ —Å–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
        setTimeout(() => {
            addIdsToHeadings(); // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
        }, 100);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
        setTimeout(() => {
            initTocInteractivity();
        }, 200);
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ)
        const urlParams = new URLSearchParams(window.location.search);
        const currentPageNum = parseInt(urlParams.get('page')) || 1;
        setTimeout(() => {
            const allPages = document.querySelectorAll('.article-page');
            allPages.forEach(page => {
                const pageNum = parseInt(page.getAttribute('data-page'));
                if (pageNum === currentPageNum) {
                    page.style.display = '';
                } else {
                    page.style.display = 'none';
                }
            });
        }, 50);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        initPagination();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º (–ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
        setTimeout(() => {
            if (typeof updatePageNavigationButtons === 'function') {
                updatePageNavigationButtons();
            }
        }, 100);
        
    } catch (error) {
        console.error('[ArticleView] Error loading article:', error);
        console.error('[ArticleView] Error name:', error.name);
        console.error('[ArticleView] Error message:', error.message);
        console.error('[ArticleView] Error stack:', error.stack);
        console.error('[ArticleView] Full error object:', JSON.stringify(error, Object.getOwnPropertyNames(error), 2));
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        let errorDetails = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        if (error.stack) {
            errorDetails += '\n\nStack trace:\n' + error.stack;
        }
        if (error.cause) {
            errorDetails += '\n\nCause: ' + JSON.stringify(error.cause);
        }
        
        const errorHtml = `
            <div class="article-error">
                <h2>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏</h2>
                <p><strong>${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</strong></p>
                <details style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);" open>
                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)</summary>
                    <pre style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto;">${escapeHtml(errorDetails)}</pre>
                </details>
                <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <p><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:</strong></p>
                    <ul style="list-style: disc; padding-left: 1.5rem; margin-top: 0.5rem;">
                        <li>URL: ${window.location.href}</li>
                        <li>Base Path: ${window.router?.basePath || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}</li>
                        <li>Article ID: ${articleId || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}</li>
                        <li>User Agent: ${navigator.userAgent.substring(0, 100)}...</li>
                    </ul>
                </div>
            </div>
        `;
        const bodyEl = document.getElementById('article-body');
        if (bodyEl) {
            bodyEl.innerHTML = errorHtml;
        } else {
            console.error('[ArticleView] article-body element not found for error display!');
        }
    }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é
    function initArticleView() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ DOM –≥–æ—Ç–æ–≤
        if (!document.getElementById('article-body')) {
            setTimeout(initArticleView, 100);
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç–∞—Ç—å–∏
        let articleId = getArticleId();
        
        // –í—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç–∞—Ç—å–∏, –µ—Å–ª–∏ ID –Ω–∞–π–¥–µ–Ω —Å—Ä–∞–∑—É
        if (articleId) {
            loadArticle(articleId);
        } else {
            // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–∞–∑—É, –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (–¥–ª—è SPA)
            let retryCount = 0;
            const maxRetries = 5;
            
            const retryInterval = setInterval(() => {
                retryCount++;
                
                articleId = getArticleId();
                if (articleId) {
                    clearInterval(retryInterval);
                    loadArticle(articleId);
                } else if (retryCount >= maxRetries) {
                    console.error('[ArticleView] Max retries reached, showing error');
                    clearInterval(retryInterval);
                    const errorHtml = `
                        <div class="article-error">
                            <h2>‚ùå –°—Ç–∞—Ç—å—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞</h2>
                            <p>–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—Ç–∞—Ç—å–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                                URL: ${window.location.href}
                            </p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Search: ${window.location.search}
                            </p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Router: ${window.router ? 'exists' : 'not found'}
                            </p>
                            ${window.router?.currentRoute ? `<p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">Current Route: ${window.router.currentRoute}</p>` : ''}
                        </div>
                    `;
                    const bodyEl = document.getElementById('article-body');
                    if (bodyEl) {
                        bodyEl.innerHTML = errorHtml;
                    }
                }
            }, 200);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initArticleView);
    } else {
        // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        initArticleView();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    document.getElementById('back-to-articles').addEventListener('click', () => {
        if (window.router) {
            window.router.navigate('/articles');
        } else {
            window.location.href = '/articles';
        }
    });
    
    // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ markdown –≤ HTML
    function simpleMarkdownToHtml(md) {
        let html = md;
        
        // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ —Ñ–æ—Ä–º—É–ª [formula]...[/formula]
        // –°–∏–Ω—Ç–∞–∫—Å–∏—Å: [formula:–ø–∞—Ä–∞–º–µ—Ç—Ä—ã]...[/formula]
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: inline (–≤ —Å—Ç—Ä–æ–∫–µ), border (—Å —Ä–∞–º–∫–æ–π)
        // –ü—Ä–∏–º–µ—Ä—ã:
        //   [formula]...[/formula] - –ø–æ —Ü–µ–Ω—Ç—Ä—É, –±–µ–∑ —Ä–∞–º–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        //   [formula:inline]...[/formula] - –≤ —Å—Ç—Ä–æ–∫–µ
        //   [formula:border]...[/formula] - —Å —Ä–∞–º–∫–æ–π
        //   [formula:inline:border]...[/formula] - –≤ —Å—Ç—Ä–æ–∫–µ —Å —Ä–∞–º–∫–æ–π
        //   ¬´—Ñ–æ—Ä–º—É–ª–∞¬ª - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è inline —Ñ–æ—Ä–º—É–ª (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ –∫–∞–≤—ã—á–∫–∏)
        const formulaBlocks = [];
        const codeBlocks = [];
        const latexFormulaBlocks = [];
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ —Å —Ç—Ä–µ–º—è –æ–±—Ä–∞—Ç–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏ –ü–ï–†–í–´–ú–ò
        // –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –∫–æ–¥ –æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∫ markdown/—Ñ–æ—Ä–º—É–ª—ã
        html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
            const index = codeBlocks.length;
            const trimmedCode = code.trim();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π (—Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã)
            // –ù–ï —Ñ–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª—ã —Ç–∞–±–ª–∏—Ü—ã (|) - —Ç–∞–±–ª–∏—Ü—ã –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –∫–æ–¥
            const codeLines = trimmedCode.split('\n');
            const hasTableMarkers = codeLines.some(line => {
                const trimmed = line.trim();
                return trimmed.includes('|') && trimmed.split('|').length >= 3; // –ú–∏–Ω–∏–º—É–º 3 —á–∞—Å—Ç–∏ (–Ω–∞—á–∞–ª–æ, —Å–µ—Ä–µ–¥–∏–Ω–∞, –∫–æ–Ω–µ—Ü)
            });
            
            // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–¥ (–Ω–µ —Ñ–æ—Ä–º—É–ª–∞)
            if (hasTableMarkers) {
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                return `\n__CODE_BLOCK_${index}__\n`;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π
            // –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞:
            // 1. –°–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã (–≥—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã) –ò–õ–ò
            // 2. –ë—ã—Ç—å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–π (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞) —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ (=, +, -, *, /, ^, _)
            // 3. –ù–ï –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–Ω–æ–≥–æ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–º–Ω–æ–≥–æ —Å–ª–æ–≤, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            
            const mathSymbols = /[œÄŒ∏œÜœáœàœâŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ‚àà‚àâ‚äÇ‚äÉ‚à™‚à©‚àÖ‚àû‚àë‚àè‚à´‚àÇ‚àá‚Ñù‚Ñï‚Ñ§‚Ñö]/;
            const mathOperators = /[=+\-*/^_()\[\]{}]/;
            const hasMathSymbols = mathSymbols.test(trimmedCode);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–º–Ω–æ–≥–æ —Å–ª–æ–≤, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            const wordCount = trimmedCode.split(/\s+/).filter(w => w.length > 2).length;
            const hasManyWords = wordCount > 5; // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 5 —Å–ª–æ–≤, —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç
            const hasSentences = trimmedCode.match(/[.!?]\s+[–ê-–ØA-Z]/); // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
            
            // –§–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏:
            // - –°–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –ò–õ–ò
            // - –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞) —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏ –ù–ï –º–Ω–æ–≥–æ —Å–ª–æ–≤
            const isFormula = hasMathSymbols || 
                             (trimmedCode.length < 100 && 
                              mathOperators.test(trimmedCode) && 
                              !hasManyWords && 
                              !hasSentences && 
                              !hasTableMarkers &&
                              trimmedCode.split('\n').length <= 3); // –ú–∞–∫—Å–∏–º—É–º 3 —Å—Ç—Ä–æ–∫–∏
            
            if (isFormula) {
                // –§–æ—Ä–º—É–ª–∞ - –≤—ã–≤–æ–¥–∏–º —Å –∫–ª–∞—Å—Å–æ–º formula-block
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<div class="formula-block">${escaped}</div>`);
            } else {
                // –û–±—ã—á–Ω—ã–π –∫–æ–¥
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –∏–Ω–¥–µ–∫—Å–æ–º
            return `\n__CODE_BLOCK_${index}__\n`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º LaTeX —Ñ–æ—Ä–º—É–ª—ã $$...$$ (block —Ñ–æ—Ä–º—É–ª—ã) –ü–ï–†–ï–î –æ–±—Ä–∞–±–æ—Ç–∫–æ–π $...$ (inline)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–∂–∞–¥–Ω—ã–π –∫–≤–∞–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
        html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
            const index = latexFormulaBlocks.length;
            const trimmedFormula = formula.trim();
            // –ù–ï —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º - MathJax –Ω—É–∂–µ–Ω –∏—Å—Ö–æ–¥–Ω—ã–π LaTeX —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
            latexFormulaBlocks.push(`<div class="math-display">$$${trimmedFormula}$$</div>`);
            return `__LATEX_FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º LaTeX —Ñ–æ—Ä–º—É–ª—ã $...$ (inline —Ñ–æ—Ä–º—É–ª—ã)
        // –í–∞–∂–Ω–æ: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ $$...$$, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥: –∏—â–µ–º –≤—Å–µ $...$, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞
        // –ü–æ—Å–∫–æ–ª—å–∫—É $$...$$ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è $ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å inline —Ñ–æ—Ä–º—É–ª–∞–º–∏
        html = html.replace(/\$([^$\n]+?)\$/g, (match, formula) => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            if (match.includes('__LATEX_FORMULA_BLOCK_')) {
                return match;
            }
            const index = latexFormulaBlocks.length;
            const trimmedFormula = formula.trim();
            // –ù–ï —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º - MathJax –Ω—É–∂–µ–Ω –∏—Å—Ö–æ–¥–Ω—ã–π LaTeX —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
            latexFormulaBlocks.push(`<span class="math-inline">$${trimmedFormula}$</span>`);
            return `__LATEX_FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ –∫–∞–≤—ã—á–∫–∏ ¬´¬ª –∫–∞–∫ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç [formula:inline]...[/formula]
        html = html.replace(/¬´([^¬ª]+)¬ª/g, (match, formula) => {
            const index = formulaBlocks.length;
            const trimmedFormula = formula.trim();
            
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É
            const escaped = trimmedFormula
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è inline —Ñ–æ—Ä–º—É–ª—ã
            formulaBlocks.push(`<span class="formula-block formula-inline">${escaped}</span>`);
            return `__FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–≥–∏ [formula]...[/formula]
        html = html.replace(/\[formula(?::([^\]]+))?\]([\s\S]*?)\[\/formula\]/g, (match, params, formula) => {
            const index = formulaBlocks.length;
            const trimmedFormula = formula.trim();
            
            // –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const paramList = params ? params.split(':').map(p => p.trim()) : [];
            const isInline = paramList.includes('inline');
            const hasBorder = paramList.includes('border');
            
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É
            const escaped = trimmedFormula
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Ñ–æ—Ä–º—É–ª—ã
            let classes = 'formula-block';
            if (isInline) classes += ' formula-inline';
            if (hasBorder) classes += ' formula-border';
            
            // –î–ª—è inline —Ñ–æ—Ä–º—É–ª –∏—Å–ø–æ–ª—å–∑—É–µ–º span, –¥–ª—è –±–ª–æ—á–Ω—ã—Ö - div
            const tag = isInline ? 'span' : 'div';
            formulaBlocks.push(`<${tag} class="${classes}">${escaped}</${tag}>`);
            return `__FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ (``` –±–µ–∑ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö ```)
        // –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫
        // –ò—â–µ–º –±–ª–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å ```, –Ω–æ –Ω–µ –∏–º–µ—é—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        const htmlLines = html.split('\n');
        let inUnclosedBlock = false;
        let unclosedBlockContent = [];
        let unclosedBlockStartLine = -1;
        
        for (let i = 0; i < htmlLines.length; i++) {
            const line = htmlLines[i];
            const trimmedLine = line.trim();
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (line.includes('__CODE_BLOCK_')) {
                continue;
            }
            
            // –ù–∞—á–∞–ª–æ –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ –±–ª–æ–∫–∞
            if (trimmedLine === '```' && !inUnclosedBlock) {
                inUnclosedBlock = true;
                unclosedBlockContent = [];
                unclosedBlockStartLine = i;
                continue;
            }
            
            // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ –±–ª–æ–∫–∞
            if (inUnclosedBlock) {
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ –∫–∞–≤—ã—á–∫–∏, –±–ª–æ–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤—ã—à–µ
                if (trimmedLine === '```') {
                    inUnclosedBlock = false;
                    continue;
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                unclosedBlockContent.push(line);
            }
        }
        
        // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
        if (inUnclosedBlock && unclosedBlockContent.length > 0) {
            const code = unclosedBlockContent.join('\n');
            const trimmedCode = code.trim();
            
            if (trimmedCode) {
                const index = codeBlocks.length;
                
                // –ù–ï —Ñ–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª—ã —Ç–∞–±–ª–∏—Ü—ã (|)
                const codeLines = trimmedCode.split('\n');
                const hasTableMarkers = codeLines.some(line => {
                    const trimmed = line.trim();
                    return trimmed.includes('|') && trimmed.split('|').length >= 3; // –ú–∏–Ω–∏–º—É–º 3 —á–∞—Å—Ç–∏
                });
                
                if (hasTableMarkers) {
                    // –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–¥ (–Ω–µ —Ñ–æ—Ä–º—É–ª–∞)
                    const escaped = trimmedCode
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                    htmlLines[unclosedBlockStartLine] = `__CODE_BLOCK_${codeBlocks.length - 1}__`;
                    for (let j = unclosedBlockStartLine + 1; j < htmlLines.length; j++) {
                        if (htmlLines[j].includes('__CODE_BLOCK_')) break;
                        htmlLines[j] = '';
                    }
                } else {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –≤—ã—à–µ)
                const mathSymbols = /[œÄŒ∏œÜœáœàœâŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ‚àà‚àâ‚äÇ‚äÉ‚à™‚à©‚àÖ‚àû‚àë‚àè‚à´‚àÇ‚àá‚Ñù‚Ñï‚Ñ§‚Ñö]/;
                const mathOperators = /[=+\-*/^_()\[\]{}]/;
                const hasMathSymbols = mathSymbols.test(trimmedCode);
                
                const wordCount = trimmedCode.split(/\s+/).filter(w => w.length > 2).length;
                const hasManyWords = wordCount > 5;
                const hasSentences = trimmedCode.match(/[.!?]\s+[–ê-–ØA-Z]/);
                
                const isFormula = hasMathSymbols || 
                                 (trimmedCode.length < 100 && 
                                  mathOperators.test(trimmedCode) && 
                                  !hasManyWords && 
                                  !hasSentences && 
                                  !hasTableMarkers &&
                                  trimmedCode.split('\n').length <= 3);
                    
                    if (isFormula) {
                        const escaped = trimmedCode
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        codeBlocks.push(`<div class="formula-block">${escaped}</div>`);
                    } else {
                        const escaped = trimmedCode
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                    }
                    
                    // –ó–∞–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                    htmlLines[unclosedBlockStartLine] = `__CODE_BLOCK_${index}__`;
                    for (let j = unclosedBlockStartLine + 1; j < htmlLines.length; j++) {
                        if (htmlLines[j].includes('__CODE_BLOCK_')) break; // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                        htmlLines[j] = '';
                    }
                }
            }
        }
        
        html = htmlLines.join('\n');
        
        // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º inline —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤) –î–û –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        // —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–æ–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å
        
        // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (inline, –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–ï–†–ï–î –∫—É—Ä—Å–∏–≤–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        html = html.replace(/\*\*([^\n*]+?)\*\*/g, '<strong>$1</strong>');
        
        // –ö—É—Ä—Å–∏–≤ (inline, –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–û–°–õ–ï –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º [^\n*]+? —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –∑–≤–µ–∑–¥–æ—á–∫–∏
        html = html.replace(/\*([^\n*]+?)\*/g, '<em>$1</em>');
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–û–°–õ–ï —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å)
        html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        
        // –¢–∞–±–ª–∏—Ü—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
        // –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã: –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, —Å—Ç—Ä–æ–∫–∏
        // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏—â–µ—Ç: |–∑–∞–≥–æ–ª–æ–≤–æ–∫|, |---|, |–¥–∞–Ω–Ω—ã–µ|
        html = html.replace(/(\|[^\n]+\|\n\|[-\s|:]+\|\n(?:\|[^\n]+\|\n?)+)/g, (match) => {
            const lines = match.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return match;
            
            const headerLine = lines[0];
            const dataLines = lines.slice(2); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            
            // –ü–∞—Ä—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const headers = headerLine.split('|')
                .map(h => h.trim())
                .filter(h => h && !h.match(/^[-:\s]+$/)); // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
            
            if (headers.length === 0) return match;
            
            const headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            const bodyRows = dataLines.map(row => {
                const cells = row.split('|')
                    .map(c => c.trim())
                    .filter(c => c && !c.match(/^[-:\s]+$/)); // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                
                if (cells.length === 0) return '';
                return '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            }).filter(row => row).join('');
            
            if (!bodyRows) return match;
            
            return `<table class="article-table"><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
        });
        
        // Inline –∫–æ–¥ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–ï–†–ï–î —Å—Å—ã–ª–∫–∞–º–∏, —á—Ç–æ–±—ã —Ñ–æ—Ä–º—É–ª—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –∫–∞–∫ —Å—Å—ã–ª–∫–∏)
        const inlineCodeBlocks = [];
        html = html.replace(/`([^`]+)`/g, (match, code) => {
            const index = inlineCodeBlocks.length;
            const escaped = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            inlineCodeBlocks.push(`<code>${escaped}</code>`);
            return `__INLINE_CODE_${index}__`;
        });
        
        // –°—Å—ã–ª–∫–∏ (—Ñ–æ—Ä–º–∞—Ç markdown: [—Ç–µ–∫—Å—Ç](url))
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∫—Ä—É–≥–ª—ã—Ö —Å–∫–æ–±–∫–∞—Ö —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º URL
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
            if (!url) return match;
            
            const trimmedUrl = url.trim();
            const trimmedText = text.trim();
            
            // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º
            // –í–∞–ª–∏–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
            // - http://, https:// (—Å –¥–æ–º–µ–Ω–æ–º)
            // - mailto:email@domain.com
            // - –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏: /path, ./path, ../path
            // - –Ø–∫–æ—Ä—è: #anchor
            // - –î—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã: ftp://, file:// –∏ —Ç.–¥.
            
            let isValidUrl = false;
            
            // HTTP/HTTPS - –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω
            if (trimmedUrl.startsWith('http://') || trimmedUrl.startsWith('https://')) {
                isValidUrl = /^https?:\/\/[^\s/$.?#]+\.[^\s]+/i.test(trimmedUrl);
            }
            // mailto - –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å @
            else if (trimmedUrl.startsWith('mailto:')) {
                isValidUrl = trimmedUrl.includes('@');
            }
            // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
            else if (trimmedUrl.startsWith('/') || trimmedUrl.startsWith('./') || trimmedUrl.startsWith('../')) {
                isValidUrl = /^[./][^\s]*$/.test(trimmedUrl);
            }
            // –Ø–∫–æ—Ä—è
            else if (trimmedUrl.startsWith('#')) {
                isValidUrl = /^#[a-zA-Z0-9_-]+$/.test(trimmedUrl);
            }
            // –î—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã (ftp:, file: –∏ —Ç.–¥.)
            else if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmedUrl)) {
                isValidUrl = true;
            }
            // –ü—Ä–æ—Å—Ç—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤/—è–∫–æ—Ä—è (–±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ –±–µ–∑ /)
            else if (/^[a-zA-Z0-9._-]+$/.test(trimmedUrl)) {
                isValidUrl = true;
            }
            
            if (!isValidUrl) return match;
            
            return `<a href="${trimmedUrl}">${trimmedText}</a>`;
        });
        
        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
        html = html.replace(/^---$/gim, '<hr>');
        
        // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã –∏ —Å–ø–∏—Å–∫–∏ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫)
        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ
        const lines = html.split('\n');
        const result = [];
        let currentPara = [];
        let currentList = [];
        let currentListType = null; // 'ul' –∏–ª–∏ 'ol'
        
        function flushList() {
            if (currentList.length > 0) {
                const listTag = currentListType === 'ol' ? 'ol' : 'ul';
                result.push(`<${listTag}>${currentList.join('\n')}</${listTag}>`);
                currentList = [];
                currentListType = null;
            }
        }
        
        function flushPara() {
            if (currentPara.length > 0) {
                const paraText = currentPara.join('\n');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —É–∂–µ HTML —Ç–µ–≥–æ–º –∏–ª–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º
                if (paraText.includes('__CODE_BLOCK_') || paraText.includes('__FORMULA_BLOCK_')) {
                    // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                    const parts = paraText.split(/(__CODE_BLOCK_\d+__|__FORMULA_BLOCK_\d+__)/);
                    parts.forEach(part => {
                        if (part.match(/^__(CODE|FORMULA)_BLOCK_\d+__$/)) {
                            result.push(part);
                        } else if (part.trim()) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, –∑–∞–º–µ–Ω—è—è –∏—Ö –Ω–∞ <br>
                            const paraWithBreaks = part.replace(/\n/g, '<br>');
                            result.push(`<p>${paraWithBreaks}</p>`);
                        }
                    });
                } else if (paraText.startsWith('<') && paraText.match(/^(<h[1-6]|<ul|<ol|<li|<table|<hr|<pre|<div)/)) {
                    result.push(paraText);
                } else {
                    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ <br> –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞–º–µ–Ω—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
                    const paraWithBreaks = paraText.replace(/\n/g, '<br>');
                    result.push(`<p>${paraWithBreaks}</p>`);
                }
                currentPara = [];
            }
        }
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            
            // –ï—Å–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫
            if (!trimmed) {
                flushList();
                flushPara();
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–ø–∏—Å–∫–∞
            const listMatch = trimmed.match(/^(\d+\.|\-|\*)\s+(.+)$/);
            if (listMatch) {
                flushPara(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º
                const isOrdered = /^\d+\./.test(listMatch[1]);
                const listType = isOrdered ? 'ol' : 'ul';
                const content = listMatch[2];
                
                // –ï—Å–ª–∏ —Ç–∏–ø —Å–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è, –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ø–∏—Å–æ–∫
                if (currentListType && currentListType !== listType) {
                    flushList();
                }
                
                currentListType = listType;
                currentList.push(`<li>${content}</li>`);
                continue;
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –±–ª–æ–∫–∞ –∫–æ–¥–∞ –∏–ª–∏ —Ñ–æ—Ä–º—É–ª—ã - –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º
            if (trimmed.includes('__CODE_BLOCK_') || trimmed.includes('__FORMULA_BLOCK_')) {
                flushList();
                flushPara();
                result.push(trimmed);
                continue;
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å HTML —Ç–µ–≥–∞ - –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥
            if (trimmed.startsWith('<') && trimmed.match(/^<(h[1-6]|ul|ol|li|table|hr|pre|div)/)) {
                flushList();
                flushPara();
                result.push(trimmed);
                continue;
            }
            
            // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É (—Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏), –∞ –Ω–µ trimmed
            flushList(); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–º
            currentPara.push(line);
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫
        flushList();
        flushPara();
        
        html = result.join('\n');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º inline –∫–æ–¥ (–ø–µ—Ä–µ–¥ –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞)
        inlineCodeBlocks.forEach((block, index) => {
            html = html.replace(`__INLINE_CODE_${index}__`, block);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ–π –∑–∞–º–µ–Ω—ã)
        codeBlocks.forEach((block, index) => {
            const placeholder = new RegExp(`__CODE_BLOCK_${index}__`, 'g');
            html = html.replace(placeholder, block);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞)
        formulaBlocks.forEach((block, index) => {
            const placeholder = new RegExp(`__FORMULA_BLOCK_${index}__`, 'g');
            html = html.replace(placeholder, block);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º LaTeX —Ñ–æ—Ä–º—É–ª—ã (–ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ä–º—É–ª)
        latexFormulaBlocks.forEach((block, index) => {
            const placeholder = new RegExp(`__LATEX_FORMULA_BLOCK_${index}__`, 'g');
            html = html.replace(placeholder, block);
        });
        
        return html;
    }
    
    /**
     * –†–∞–∑–±–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—å—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (h2)
     * @param {string} html - HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏
     * @param {string} tocHtml - HTML —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     * @param {string} articleId - ID —Å—Ç–∞—Ç—å–∏
     * @returns {string} - HTML —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     */
    function paginateArticle(html, tocHtml, articleId) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ h2 –∑–∞–≥–æ–ª–æ–≤–∫–∏
        const h2Elements = tempDiv.querySelectorAll('h2');
        
        if (h2Elements.length <= 1) {
            // –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –º–∞–ª–æ, –Ω–µ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            let result = '';
            if (tocHtml) {
                result += '<div class="article-toc-embedded">';
                result += '<h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>';
                result += tocHtml;
                result += '</div>';
                result += '<hr style="margin: 2rem 0;">';
            }
            result += html;
            return result;
        }
        
        const pages = [];
        let currentPage = [];
        let pageNumber = 1;
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        const allElements = Array.from(tempDiv.children);
        
        for (let i = 0; i < allElements.length; i++) {
            const element = allElements[i];
            
            // –ï—Å–ª–∏ —ç—Ç–æ h2 –∏ –Ω–µ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (element.tagName === 'H2' && currentPage.length > 0) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                pages.push({
                    number: pageNumber++,
                    content: currentPage.map(el => el.outerHTML).join('')
                });
                // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                currentPage = [element];
            } else {
                currentPage.push(element);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        if (currentPage.length > 0) {
            pages.push({
                number: pageNumber,
                content: currentPage.map(el => el.outerHTML).join('')
            });
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentPageNum = parseInt(urlParams.get('page')) || 1;
        const activePage = Math.max(1, Math.min(currentPageNum, pages.length));
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        // –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–µ–º –í–°–ï —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ DOM (–¥–∞–∂–µ —Å–∫—Ä—ã—Ç—ã–µ), —á—Ç–æ–±—ã ID –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        let result = '';
        
        // –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å display: none)
        pages.forEach((page, index) => {
            const pageNum = index + 1;
            const isActive = pageNum === activePage;
            
            result += `<div class="article-page" data-page="${pageNum}" ${!isActive ? 'style="display: none;"' : ''}>`;
            
            // –ù–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ
            if (pageNum === 1 && tocHtml) {
                result += '<div class="article-toc-embedded">';
                result += '<h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>';
                result += tocHtml;
                result += '</div>';
                result += '<hr style="margin: 2rem 0;">';
            } else if (pageNum > 1) {
                // –ù–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
                const currentPageContent = page.content;
                const tempPageDiv = document.createElement('div');
                tempPageDiv.innerHTML = currentPageContent;
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π h2 –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const firstH2 = tempPageDiv.querySelector('h2');
                if (firstH2) {
                    const sectionTitle = firstH2.textContent.trim();
                    const sectionId = firstH2.id || '';
                    
                    // –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–π h2 –∏–∑ content, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                    firstH2.remove();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º content –±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ h2
                    const updatedContent = tempPageDiv.innerHTML;
                    
                    result += '<div class="article-section-header">';
                    if (sectionId) {
                        result += `<h2 id="${sectionId}" class="article-section-title">${sectionTitle}</h2>`;
                    } else {
                        result += `<h2 class="article-section-title">${sectionTitle}</h2>`;
                    }
                    result += '</div>';
                    result += '<hr style="margin: 1.5rem 0;">';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º content –±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ h2
                    result += updatedContent;
                } else {
                    // –ï—Å–ª–∏ h2 –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º content
                    result += currentPageContent;
                }
            } else {
                result += page.content;
            }
            
            result += `</div>`;
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        result += generatePagination(pages, activePage, articleId);
        
        return result;
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
     * @param {Array} pages - –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
     * @param {number} currentPage - –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     * @param {string} articleId - ID —Å—Ç–∞—Ç—å–∏
     * @returns {string} - HTML –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     */
    function generatePagination(pages, currentPage, articleId) {
        if (!pages || pages.length === 0) {
            return '';
        }
        
        let html = '<div class="article-pagination">';
        
        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        const prevText = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
        if (currentPage > 1) {
            const prevPage = String(currentPage - 1);
            html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + prevPage + '" class="pagination-btn pagination-prev" data-link>' + prevText + '</a>';
        } else {
            html += '<span class="pagination-btn pagination-prev pagination-disabled">' + prevText + '</span>';
        }
        
        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        html += '<div class="pagination-numbers">';
        for (let i = 1; i <= pages.length; i++) {
            const pageNum = String(i);
            if (i === currentPage) {
                html += '<span class="pagination-number pagination-active">' + pageNum + '</span>';
            } else {
                html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + pageNum + '" class="pagination-number" data-link>' + pageNum + '</a>';
            }
        }
        html += '</div>';
        
        // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
        const nextText = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
        if (currentPage < pages.length) {
            const nextPage = String(currentPage + 1);
            html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + nextPage + '" class="pagination-btn pagination-next" data-link>' + nextText + '</a>';
        } else {
            html += '<span class="pagination-btn pagination-next pagination-disabled">' + nextText + '</span>';
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π" (–≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º)
        if (currentPage > 1) {
            html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=1" class="pagination-btn pagination-home" data-link title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é">üè† –î–æ–º–æ–π</a>';
        }
        
        html += '</div>';
        
        return html;
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ID –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –≤ TableOfContents)
     */
    function generateHeadingId(text, index) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1.2. " –∏–ª–∏ "1. ")
        const numberMatch = text.match(/^(\d+(?:\.\d+)*)\.\s*(.*)/);
        let numberPrefix = '';
        let cleanText = text;
        
        if (numberMatch) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é (1.2. -> 12, 1. -> 1)
            numberPrefix = numberMatch[1].replace(/\./g, '') + '-';
            cleanText = numberMatch[2];
        } else {
            // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É
            cleanText = text.replace(/^\d+\.?\s*/, '');
        }
        
        let id = cleanText
            .toLowerCase()
            // –£–¥–∞–ª—è–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã
            .replace(/[^–∞-—èa-z0-9\s-]/g, '')
            // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –¥–µ—Ñ–∏—Å—ã
            .replace(/\s+/g, '-')
            // –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –¥–µ—Ñ–∏—Å—ã
            .replace(/-+/g, '-')
            // –£–±–∏—Ä–∞–µ–º –¥–µ—Ñ–∏—Å—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            .replace(/^-|-$/g, '');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Å –Ω–æ–º–µ—Ä–æ–º, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (numberPrefix && id) {
            id = numberPrefix + id;
        }
        
        // –ï—Å–ª–∏ ID –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
        if (!id) {
            id = `section-${index}`;
        }
        
        // –ï—Å–ª–∏ ID –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —è–∫–æ—Ä–µ–π HTML
        // (HTML5 –ø–æ–∑–≤–æ–ª—è–µ—Ç ID –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ü–∏—Ñ—Ä—ã, –Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)
        
        return id;
    }
    
    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç ID –∫–æ –≤—Å–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –¥–ª—è —è–∫–æ—Ä–µ–π
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ)
     */
    function addIdsToHeadings() {
        const articleBody = document.getElementById('article-body');
        if (!articleBody) {
            return;
        }
        
        // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–æ –í–°–ï–• —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ)
        // querySelectorAll —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ —Å–æ —Å–∫—Ä—ã—Ç—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
        const headings = articleBody.querySelectorAll('h1, h2, h3, h4, h5, h6');
        let index = 0;
        let addedCount = 0;
        let skippedCount = 0;
        const processedIds = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö ID
        
        headings.forEach(heading => {
            // –ï—Å–ª–∏ ID —É–∂–µ –µ—Å—Ç—å –∏ –æ–Ω —É–Ω–∏–∫–∞–ª–µ–Ω, –Ω–µ –º–µ–Ω—è–µ–º –µ–≥–æ
            if (heading.id && !processedIds.has(heading.id)) {
                processedIds.add(heading.id);
                skippedCount++;
                return;
            }
            
            // –ï—Å–ª–∏ ID —É–∂–µ –µ—Å—Ç—å, –Ω–æ –æ–Ω –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
            if (heading.id && processedIds.has(heading.id)) {
                // ID –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π
                const text = heading.textContent.trim();
                const id = generateHeadingId(text, index);
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–æ–≤—ã–π ID —É–Ω–∏–∫–∞–ª–µ–Ω
                let uniqueId = id;
                let counter = 1;
                while (processedIds.has(uniqueId)) {
                    uniqueId = `${id}-${counter}`;
                    counter++;
                }
                heading.id = uniqueId;
                processedIds.add(uniqueId);
                addedCount++;
                index++;
                return;
            }
            
            // –ï—Å–ª–∏ ID –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –µ–≥–æ
            const text = heading.textContent.trim();
            let id = generateHeadingId(text, index);
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ ID —É–Ω–∏–∫–∞–ª–µ–Ω
            let uniqueId = id;
            let counter = 1;
            while (processedIds.has(uniqueId)) {
                uniqueId = `${id}-${counter}`;
                counter++;
            }
            
            heading.id = uniqueId;
            processedIds.add(uniqueId);
            addedCount++;
            index++;
        });
        
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
     */
    function initTocLinks(container) {
        if (!container) {
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
        container.addEventListener('click', (e) => {
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Å—Å—ã–ª–∫—É
            const link = e.target.closest('a[href^="#"], a[data-toc-target]');
            if (!link) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º targetId –∏–∑ href –∏–ª–∏ data-toc-target
            let targetId = link.getAttribute('data-toc-target');
            if (!targetId) {
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    targetId = href.substring(1);
                }
            }
            
            if (targetId) {
                scrollToHeading(targetId);
            }
        });
    }
    
    /**
     * –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∑–∞–≥–æ–ª–æ–≤–∫—É –ø–æ ID
     */
    function scrollToHeading(targetId) {
        if (!targetId) {
            return;
        }
        
        // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ ID –≤–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ
        let targetElement = document.getElementById(targetId);
        let targetPage = null;
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        if (!targetElement) {
            const allPages = document.querySelectorAll('.article-page');
            
            for (const page of allPages) {
                const foundElement = document.getElementById(targetId);
                if (foundElement && page.contains(foundElement)) {
                    targetElement = foundElement;
                    targetPage = page;
                    break;
                }
            }
        } else {
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é —ç–ª–µ–º–µ–Ω—Ç
            const allPages = document.querySelectorAll('.article-page');
            for (const page of allPages) {
                if (page.contains(targetElement)) {
                    targetPage = page;
                    break;
                }
            }
        }
        
        if (!targetElement) {
            return;
        }
        
        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ—ë
        if (targetPage) {
            const pageNum = parseInt(targetPage.getAttribute('data-page'));
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            const currentPage = parseInt(urlParams.get('page')) || 1;
            
            if (pageNum !== currentPage) {
                const url = `/article?id=${encodeURIComponent(articleId)}&page=${pageNum}#${targetId}`;
                if (window.router) {
                    window.router.navigate(url);
                } else {
                    window.location.href = url;
                }
                return;
            }
            
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
            if (targetPage.style.display === 'none') {
                targetPage.style.display = '';
            }
        }
        
        // –ñ–¥—ë–º, –ø–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–∏–º—ã–º
        const performScroll = () => {
            const headerOffset = 120; // –û—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–∞
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º getBoundingClientRect –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
            const rect = targetElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const elementTop = rect.top + scrollTop;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å —É—á–µ—Ç–æ–º –æ—Ç—Å—Ç—É–ø–∞
            const offsetPosition = elementTop - headerOffset;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
            window.scrollTo({
                top: Math.max(0, offsetPosition),
                behavior: 'smooth'
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL
            if (history.pushState) {
                const currentUrl = window.location.href.split('#')[0];
                history.pushState(null, null, `${currentUrl}#${targetId}`);
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç, –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º
        if (targetElement.offsetParent !== null) {
            // –≠–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–Ω, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ä–∞–∑—É
            setTimeout(performScroll, 100);
        } else {
            // –≠–ª–µ–º–µ–Ω—Ç —Å–∫—Ä—ã—Ç, –∂–¥—ë–º, –ø–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–∏–º—ã–º
            setTimeout(() => {
                if (targetElement.offsetParent !== null) {
                    performScroll();
                } else {
                    // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë —Å–∫—Ä—ã—Ç, –ø—ã—Ç–∞–µ–º—Å—è –µ—â—ë —Ä–∞–∑
                    setTimeout(performScroll, 200);
                }
            }, 150);
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –≤ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏
     */
    function updateActiveTocLink(activeId) {
        if (!activeId) return;
        
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ –≤ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏
        const embeddedToc = document.querySelector('.article-toc-embedded');
        
        if (embeddedToc) {
            embeddedToc.querySelectorAll('a[href^="#"], a[data-toc-target]').forEach(link => {
                link.classList.remove('active');
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–π —Å—Å—ã–ª–∫–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ href, –∏ data-toc-target)
        const activeLinkByHref = document.querySelector(`.article-toc-embedded a[href="#${activeId}"]`);
        const activeLinkByData = document.querySelector(`.article-toc-embedded a[data-toc-target="${activeId}"]`);
        const activeLink = activeLinkByHref || activeLinkByData;
        
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
     */
    function initTocScrollTracking() {
        const articleBody = document.getElementById('article-body');
        if (!articleBody) return;
        
        const headings = articleBody.querySelectorAll('h1, h2, h3, h4, h5, h6');
        
        if (headings.length === 0) return;
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –∏—Ö –ø–æ–∑–∏—Ü–∏—è–º–∏
        const headingsArray = Array.from(headings).map(heading => ({
            id: heading.id,
            element: heading
        })).filter(h => h.id); // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å ID
        
        if (headingsArray.length === 0) return;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞
        let ticking = false;
        const scrollOffset = 100;
        
        const updateActive = () => {
            const scrollPosition = window.scrollY + scrollOffset;
            let activeHeading = null;
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            for (let i = headingsArray.length - 1; i >= 0; i--) {
                const heading = headingsArray[i];
                if (heading.element) {
                    const rect = heading.element.getBoundingClientRect();
                    const elementTop = rect.top + window.pageYOffset;
                    
                    if (elementTop <= scrollPosition) {
                        activeHeading = heading;
                        break;
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –≤ TOC
            if (activeHeading) {
                updateActiveTocLink(activeHeading.id);
            }
        };
        
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    updateActive();
                    ticking = false;
                });
                ticking = true;
            }
        });
        
        // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        updateActive();
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (–∫–ª–∏–∫–∏, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞)
     */
    function initTocInteractivity() {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –≤ embedded TOC (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const embeddedToc = document.querySelector('.article-toc-embedded');
        if (embeddedToc) {
            initTocLinks(embeddedToc);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        initTocScrollTracking();
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é
     */
    function initPagination() {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.scrollTo(0, 0);
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å—Ç–∞—Ç—å–∏
     */
    function getPaginationInfo() {
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        const currentPage = parseInt(urlParams.get('page')) || 1;
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        const pagination = document.querySelector('.article-pagination');
        if (!pagination) {
            return { articleId: articleId, currentPage: currentPage, totalPages: 1, hasPagination: false };
        }
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
        const pageNumbers = pagination.querySelectorAll('.pagination-number');
        let totalPages = 1;
        
        if (pageNumbers.length > 0) {
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            pageNumbers.forEach(num => {
                const pageNum = parseInt(num.textContent.trim());
                if (!isNaN(pageNum) && pageNum > totalPages) {
                    totalPages = pageNum;
                }
            });
        } else {
            // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const hasPrev = pagination.querySelector('.pagination-prev:not(.pagination-disabled)');
            const hasNext = pagination.querySelector('.pagination-next:not(.pagination-disabled)');
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—è
            if (hasPrev || hasNext) {
                // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è" –∏ –º—ã –Ω–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –µ—â–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                if (hasNext) {
                    totalPages = currentPage + 1; // –ú–∏–Ω–∏–º—É–º —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                } else if (hasPrev) {
                    totalPages = currentPage; // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø–æ—Å–ª–µ–¥–Ω—è—è
                }
            } else {
                // –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                return { articleId: articleId, currentPage: currentPage, totalPages: 1, hasPagination: false };
            }
        }
        
        return {
            articleId: articleId,
            currentPage: currentPage,
            totalPages: totalPages,
            hasPagination: totalPages > 1
        };
    }
    
    /**
     * –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     */
    function navigateToPrevPage() {
        const pagination = getPaginationInfo();
        if (!pagination.hasPagination || pagination.currentPage <= 1) {
            return;
        }
        
        const prevPage = pagination.currentPage - 1;
        const url = `/article?id=${encodeURIComponent(pagination.articleId)}&page=${prevPage}`;
        
        if (window.router) {
            window.router.navigate(url);
        } else {
            window.location.href = url;
        }
    }
    
    /**
     * –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     */
    function navigateToNextPage() {
        const pagination = getPaginationInfo();
        if (!pagination.hasPagination || pagination.currentPage >= pagination.totalPages) {
            return;
        }
        
        const nextPage = pagination.currentPage + 1;
        const url = `/article?id=${encodeURIComponent(pagination.articleId)}&page=${nextPage}`;
        
        if (window.router) {
            window.router.navigate(url);
        } else {
            window.location.href = url;
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
     */
    function updatePageNavigationButtons() {
        const prevBtn = document.getElementById('scroll-to-prev');
        const nextBtn = document.getElementById('scroll-to-next');
        
        if (!prevBtn || !nextBtn) return;
        
        const pagination = getPaginationInfo();
        
        if (!pagination.hasPagination) {
            // –ï—Å–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—è
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        if (pagination.currentPage <= 1) {
            prevBtn.disabled = true;
            prevBtn.classList.add('disabled');
            prevBtn.setAttribute('aria-disabled', 'true');
        } else {
            prevBtn.disabled = false;
            prevBtn.classList.remove('disabled');
            prevBtn.setAttribute('aria-disabled', 'false');
        }
        
        if (pagination.currentPage >= pagination.totalPages) {
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
            nextBtn.setAttribute('aria-disabled', 'true');
        } else {
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
            nextBtn.setAttribute('aria-disabled', 'false');
        }
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
     */
    function initScrollButtons() {
        const scrollButtons = document.getElementById('article-scroll-buttons');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
        const scrollToPrevBtn = document.getElementById('scroll-to-prev');
        const scrollToNextBtn = document.getElementById('scroll-to-next');
        
        if (!scrollButtons || !scrollToTopBtn || !scrollToBottomBtn) {
            return;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ (–∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã —á–µ—Ä–µ–∑ CSS)
        function toggleButtons() {
            // –ö–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã —á–µ—Ä–µ–∑ CSS !important, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å visible –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            scrollButtons.classList.add('visible');
        }
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞–≤–µ—Ä—Ö
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        scrollToBottomBtn.addEventListener('click', () => {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º (–≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ)
        if (scrollToPrevBtn) {
            scrollToPrevBtn.addEventListener('click', () => {
                navigateToPrevPage();
            });
        }
        
        if (scrollToNextBtn) {
            scrollToNextBtn.addEventListener('click', () => {
                navigateToNextPage();
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π" (–≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
        const scrollToHomeBtn = document.getElementById('scroll-to-home');
        if (scrollToHomeBtn) {
            scrollToHomeBtn.addEventListener('click', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const articleId = urlParams.get('id');
                const url = `/article?id=${encodeURIComponent(articleId)}&page=1`;
                if (window.router) {
                    window.router.navigate(url);
                } else {
                    window.location.href = url;
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        updatePageNavigationButtons();
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        window.addEventListener('scroll', toggleButtons);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        toggleButtons();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', toggleButtons);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ URL (–¥–ª—è SPA)
        if (window.router) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ DOM –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            const paginationObserver = new MutationObserver(() => {
                updatePageNavigationButtons();
            });
            
            const paginationContainer = document.querySelector('.article-pagination');
            if (paginationContainer) {
                paginationObserver.observe(paginationContainer, {
                    childList: true,
                    subtree: true
                });
            }
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏
    initScrollButtons();
})();
</script>
