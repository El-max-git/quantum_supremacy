<div class="container" style="padding: 2rem 1rem;">
    <!-- Back Button -->
    <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
        <button class="back-to-list-btn" id="back-to-articles">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É
        </button>
    </div>

    <div class="article-wrapper">
        <!-- Table of Contents -->
        <aside class="article-toc-sidebar" id="article-toc-sidebar">
            <div class="toc-sticky">
                <h3 class="toc-title">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
                <div id="article-toc">
                    <!-- TOC will be generated here -->
                </div>
            </div>
        </aside>
        
        <!-- Article Content -->
        <article class="article-content" id="article-content">
            <!-- Article Header -->
            <header class="article-header">
                <div class="article-category" id="article-category"></div>
                <h1 class="article-title" id="article-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <div class="article-meta">
                    <span class="article-author" id="article-author"></span>
                    <span class="article-date" id="article-date"></span>
                    <span class="article-reading-time" id="article-reading-time"></span>
                </div>
                <div class="article-tags" id="article-tags"></div>
            </header>
            
            <!-- Article Body -->
            <div class="article-body" id="article-body">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏...</p>
                </div>
            </div>
        </article>
    </div>
</div>

<!-- Floating Navigation Buttons -->
<div class="article-scroll-buttons" id="article-scroll-buttons">
    <button class="scroll-btn scroll-btn-top" id="scroll-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞" title="–ù–∞–≤–µ—Ä—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>
    <button class="scroll-btn scroll-btn-bottom" id="scroll-to-bottom" aria-label="–í–Ω–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞" title="–í–Ω–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9l6 6 6-6"/>
        </svg>
    </button>
</div>

<!-- Article Viewer Script -->
<script>
(async function() {
    // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç–∞—Ç—å–∏ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    const urlParams = new URLSearchParams(window.location.search);
    const articleId = urlParams.get('id');
    
    if (!articleId) {
        document.getElementById('article-body').innerHTML = `
            <div class="article-error">
                <h2>‚ùå –°—Ç–∞—Ç—å—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞</h2>
                <p>–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—Ç–∞—Ç—å–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
            </div>
        `;
        return;
    }
    
    try {
        const basePath = window.router?.basePath || '';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —Å—Ç–∞—Ç–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç–∞—Ç—å–∏
        const catalogResponse = await fetch(`${basePath}/articles/articles-list.json`);
        if (!catalogResponse.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Å—Ç–∞—Ç–µ–π');
        }
        
        const catalog = await catalogResponse.json();
        
        // –ò—â–µ–º —Å—Ç–∞—Ç—å—é –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        function findArticle(items, targetId) {
            for (const item of items) {
                if (item.id === targetId && item.mdFile) {
                    return item;
                }
                if (item.items) {
                    const found = findArticle(item.items, targetId);
                    if (found) return found;
                }
            }
            return null;
        }
        
        const article = findArticle(catalog.categories || [], articleId);
        
        if (!article) {
            throw new Error(`–°—Ç–∞—Ç—å—è —Å ID "${articleId}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º markdown —Ñ–∞–π–ª
        const mdResponse = await fetch(`${basePath}/${article.mdFile}`);
        if (!mdResponse.ok) {
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å—Ç–∞—Ç—å–∏: ${article.mdFile}`);
        }
        
        const mdText = await mdResponse.text();
        
        // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ frontmatter (YAML –º–µ–∂–¥—É ---)
        let content = mdText;
        let metadata = {};
        
        const frontmatterMatch = mdText.match(/^---\r?\n([\s\S]*?)\r?\n---(\r?\n|$)/);
        if (frontmatterMatch) {
            const yamlText = frontmatterMatch[1];
            content = mdText.substring(frontmatterMatch[0].length);
            
            // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä YAML
            yamlText.split('\n').forEach(line => {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) return;
                
                const colonIndex = trimmed.indexOf(':');
                if (colonIndex === -1) return;
                
                const key = trimmed.substring(0, colonIndex).trim();
                let value = trimmed.substring(colonIndex + 1).trim();
                
                // –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
                if ((value.startsWith('"') && value.endsWith('"')) ||
                    (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.substring(1, value.length - 1);
                }
                
                // –ü–∞—Ä—Å–∏–º –º–∞—Å—Å–∏–≤—ã
                if (value.startsWith('[') && value.endsWith(']')) {
                    value = value.substring(1, value.length - 1)
                        .split(',')
                        .map(item => item.trim().replace(/^["']|["']$/g, ''));
                }
                
                metadata[key] = value;
            });
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        document.getElementById('article-title').textContent = metadata.title || articleId;
        document.getElementById('article-category').textContent = metadata.category || '–°—Ç–∞—Ç—å—è';
        document.getElementById('article-author').textContent = metadata.author || '';
        document.getElementById('article-date').textContent = metadata.date || '';
        
        if (metadata.readingTime) {
            document.getElementById('article-reading-time').textContent = `${metadata.readingTime} –º–∏–Ω —á—Ç–µ–Ω–∏—è`;
        }
        
        if (metadata.tags && metadata.tags.length) {
            const tagsHtml = metadata.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            document.getElementById('article-tags').innerHTML = tagsHtml;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º markdown –∫–∞–∫ –µ—Å—Ç—å (–±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞, —Ç–∞–∫ –∫–∞–∫ –ø–∞—Ä—Å–µ—Ä —É–¥–∞–ª–µ–Ω)
        // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π markdown –ø–∞—Ä—Å–µ—Ä –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ pre
        const escapedContent = content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä—É—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–∑ markdown (–µ—Å–ª–∏ –µ—Å—Ç—å)
        let manualToc = null;
        let articleContent = content;
        
        // –ò—â–µ–º —Ä–∞–∑–¥–µ–ª "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å —ç–º–æ–¥–∑–∏ –∏–ª–∏ –±–µ–∑)
        // –§–æ—Ä–º–∞—Ç: ## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ ... ---
        const tocHeaderPattern = /^##\s*[üìë]?\s*–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ\s*\n/;
        const tocMatch = content.match(tocHeaderPattern);
        
        if (tocMatch) {
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            const tocStart = tocMatch.index + tocMatch[0].length;
            // –ò—â–µ–º –∫–æ–Ω–µ—Ü —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ---)
            const tocEndMatch = content.substring(tocStart).match(/^\n---\n/);
            const tocEnd = tocEndMatch ? tocStart + tocEndMatch.index : content.length;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
            const tocContent = content.substring(tocStart, tocEnd).trim();
            
            if (tocContent) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ HTML
                manualToc = simpleMarkdownToHtml(tocContent);
                // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
                const tocSectionEnd = tocEndMatch ? tocEnd + tocEndMatch[0].length : content.length;
                articleContent = content.substring(0, tocMatch.index).trim() + 
                                (tocSectionEnd < content.length ? '\n\n' + content.substring(tocSectionEnd).trim() : '');
            }
        }
        
        // –ü—Ä–æ—Å—Ç–æ–π markdown –ø–∞—Ä—Å–∏–Ω–≥ (–±–∞–∑–æ–≤—ã–π)
        const html = simpleMarkdownToHtml(articleContent);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –î–û –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        let tocHtml = '';
        if (manualToc) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–∑ markdown
            tocHtml = manualToc;
        } else if (typeof TableOfContents !== 'undefined') {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TOC –∏–∑ –ø–æ–ª–Ω–æ–≥–æ HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const toc = new TableOfContents({ minHeadings: 2 });
            tocHtml = toc.generate(tempDiv);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º TOC –¥–ª—è sidebar
        document.getElementById('article-toc').innerHTML = tocHtml;
        
        // –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç–∞—Ç—å—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const paginatedHtml = paginateArticle(html, tocHtml);
        
        document.getElementById('article-body').innerHTML = paginatedHtml;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        initPagination();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è TOC
        if (typeof TableOfContents !== 'undefined' && !manualToc) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const toc = new TableOfContents({ minHeadings: 2 });
            toc.generate(tempDiv);
            toc.initScrollTracking();
        }
        
    } catch (error) {
        console.error('Error loading article:', error);
        document.getElementById('article-body').innerHTML = `
            <div class="article-error">
                <h2>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏</h2>
                <p>${error.message}</p>
            </div>
        `;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    document.getElementById('back-to-articles').addEventListener('click', () => {
        if (window.router) {
            window.router.navigate('/articles');
        } else {
            window.location.href = '/articles';
        }
    });
    
    // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ markdown –≤ HTML
    function simpleMarkdownToHtml(md) {
        let html = md;
        
        // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ —Ñ–æ—Ä–º—É–ª [formula]...[/formula]
        // –°–∏–Ω—Ç–∞–∫—Å–∏—Å: [formula:–ø–∞—Ä–∞–º–µ—Ç—Ä—ã]...[/formula]
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: inline (–≤ —Å—Ç—Ä–æ–∫–µ), border (—Å —Ä–∞–º–∫–æ–π)
        // –ü—Ä–∏–º–µ—Ä—ã:
        //   [formula]...[/formula] - –ø–æ —Ü–µ–Ω—Ç—Ä—É, –±–µ–∑ —Ä–∞–º–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        //   [formula:inline]...[/formula] - –≤ —Å—Ç—Ä–æ–∫–µ
        //   [formula:border]...[/formula] - —Å —Ä–∞–º–∫–æ–π
        //   [formula:inline:border]...[/formula] - –≤ —Å—Ç—Ä–æ–∫–µ —Å —Ä–∞–º–∫–æ–π
        //   ¬´—Ñ–æ—Ä–º—É–ª–∞¬ª - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è inline —Ñ–æ—Ä–º—É–ª (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ –∫–∞–≤—ã—á–∫–∏)
        const formulaBlocks = [];
        const codeBlocks = [];
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ –∫–∞–≤—ã—á–∫–∏ ¬´¬ª –∫–∞–∫ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç [formula:inline]...[/formula]
        html = html.replace(/¬´([^¬ª]+)¬ª/g, (match, formula) => {
            const index = formulaBlocks.length;
            const trimmedFormula = formula.trim();
            
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É
            const escaped = trimmedFormula
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è inline —Ñ–æ—Ä–º—É–ª—ã
            formulaBlocks.push(`<span class="formula-block formula-inline">${escaped}</span>`);
            return `__FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–≥–∏ [formula]...[/formula]
        html = html.replace(/\[formula(?::([^\]]+))?\]([\s\S]*?)\[\/formula\]/g, (match, params, formula) => {
            const index = formulaBlocks.length;
            const trimmedFormula = formula.trim();
            
            // –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const paramList = params ? params.split(':').map(p => p.trim()) : [];
            const isInline = paramList.includes('inline');
            const hasBorder = paramList.includes('border');
            
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É
            const escaped = trimmedFormula
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Ñ–æ—Ä–º—É–ª—ã
            let classes = 'formula-block';
            if (isInline) classes += ' formula-inline';
            if (hasBorder) classes += ' formula-border';
            
            // –î–ª—è inline —Ñ–æ—Ä–º—É–ª –∏—Å–ø–æ–ª—å–∑—É–µ–º span, –¥–ª—è –±–ª–æ—á–Ω—ã—Ö - div
            const tag = isInline ? 'span' : 'div';
            formulaBlocks.push(`<${tag} class="${classes}">${escaped}</${tag}>`);
            return `__FORMULA_BLOCK_${index}__`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ —Å —Ç—Ä–µ–º—è –æ–±—Ä–∞—Ç–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–∂–∞–¥–Ω—ã–π –∫–≤–∞–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–ª–æ–∫–æ–≤
        html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
            const index = codeBlocks.length;
            const trimmedCode = code.trim();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π (—Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã)
            // –ù–ï —Ñ–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª—ã —Ç–∞–±–ª–∏—Ü—ã (|) - —Ç–∞–±–ª–∏—Ü—ã –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –∫–æ–¥
            const codeLines = trimmedCode.split('\n');
            const hasTableMarkers = codeLines.some(line => {
                const trimmed = line.trim();
                return trimmed.includes('|') && trimmed.split('|').length >= 3; // –ú–∏–Ω–∏–º—É–º 3 —á–∞—Å—Ç–∏ (–Ω–∞—á–∞–ª–æ, —Å–µ—Ä–µ–¥–∏–Ω–∞, –∫–æ–Ω–µ—Ü)
            });
            
            // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–¥ (–Ω–µ —Ñ–æ—Ä–º—É–ª–∞)
            if (hasTableMarkers) {
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                return `\n__CODE_BLOCK_${index}__\n`;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π
            // –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞:
            // 1. –°–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã (–≥—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã) –ò–õ–ò
            // 2. –ë—ã—Ç—å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–π (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞) —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ (=, +, -, *, /, ^, _)
            // 3. –ù–ï –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–Ω–æ–≥–æ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–º–Ω–æ–≥–æ —Å–ª–æ–≤, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            
            const mathSymbols = /[œÄŒ∏œÜœáœàœâŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ‚àà‚àâ‚äÇ‚äÉ‚à™‚à©‚àÖ‚àû‚àë‚àè‚à´‚àÇ‚àá‚Ñù‚Ñï‚Ñ§‚Ñö]/;
            const mathOperators = /[=+\-*/^_()\[\]{}]/;
            const hasMathSymbols = mathSymbols.test(trimmedCode);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–º–Ω–æ–≥–æ —Å–ª–æ–≤, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            const wordCount = trimmedCode.split(/\s+/).filter(w => w.length > 2).length;
            const hasManyWords = wordCount > 5; // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 5 —Å–ª–æ–≤, —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç
            const hasSentences = trimmedCode.match(/[.!?]\s+[–ê-–ØA-Z]/); // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
            
            // –§–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏:
            // - –°–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –ò–õ–ò
            // - –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞) —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏ –ù–ï –º–Ω–æ–≥–æ —Å–ª–æ–≤
            const isFormula = hasMathSymbols || 
                             (trimmedCode.length < 100 && 
                              mathOperators.test(trimmedCode) && 
                              !hasManyWords && 
                              !hasSentences && 
                              !hasTableMarkers &&
                              trimmedCode.split('\n').length <= 3); // –ú–∞–∫—Å–∏–º—É–º 3 —Å—Ç—Ä–æ–∫–∏
            
            if (isFormula) {
                // –§–æ—Ä–º—É–ª–∞ - –≤—ã–≤–æ–¥–∏–º —Å –∫–ª–∞—Å—Å–æ–º formula-block
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<div class="formula-block">${escaped}</div>`);
            } else {
                // –û–±—ã—á–Ω—ã–π –∫–æ–¥
                const escaped = trimmedCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –∏–Ω–¥–µ–∫—Å–æ–º
            return `\n__CODE_BLOCK_${index}__\n`;
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ (``` –±–µ–∑ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö ```)
        // –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫
        // –ò—â–µ–º –±–ª–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å ```, –Ω–æ –Ω–µ –∏–º–µ—é—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        const htmlLines = html.split('\n');
        let inUnclosedBlock = false;
        let unclosedBlockContent = [];
        let unclosedBlockStartLine = -1;
        
        for (let i = 0; i < htmlLines.length; i++) {
            const line = htmlLines[i];
            const trimmedLine = line.trim();
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (line.includes('__CODE_BLOCK_')) {
                continue;
            }
            
            // –ù–∞—á–∞–ª–æ –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ –±–ª–æ–∫–∞
            if (trimmedLine === '```' && !inUnclosedBlock) {
                inUnclosedBlock = true;
                unclosedBlockContent = [];
                unclosedBlockStartLine = i;
                continue;
            }
            
            // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ –±–ª–æ–∫–∞
            if (inUnclosedBlock) {
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ –∫–∞–≤—ã—á–∫–∏, –±–ª–æ–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤—ã—à–µ
                if (trimmedLine === '```') {
                    inUnclosedBlock = false;
                    continue;
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                unclosedBlockContent.push(line);
            }
        }
        
        // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
        if (inUnclosedBlock && unclosedBlockContent.length > 0) {
            const code = unclosedBlockContent.join('\n');
            const trimmedCode = code.trim();
            
            if (trimmedCode) {
                const index = codeBlocks.length;
                
                // –ù–ï —Ñ–æ—Ä–º—É–ª–∞, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª—ã —Ç–∞–±–ª–∏—Ü—ã (|)
                const codeLines = trimmedCode.split('\n');
                const hasTableMarkers = codeLines.some(line => {
                    const trimmed = line.trim();
                    return trimmed.includes('|') && trimmed.split('|').length >= 3; // –ú–∏–Ω–∏–º—É–º 3 —á–∞—Å—Ç–∏
                });
                
                if (hasTableMarkers) {
                    // –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–¥ (–Ω–µ —Ñ–æ—Ä–º—É–ª–∞)
                    const escaped = trimmedCode
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                    htmlLines[unclosedBlockStartLine] = `__CODE_BLOCK_${codeBlocks.length - 1}__`;
                    for (let j = unclosedBlockStartLine + 1; j < htmlLines.length; j++) {
                        if (htmlLines[j].includes('__CODE_BLOCK_')) break;
                        htmlLines[j] = '';
                    }
                } else {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º—É–ª–æ–π (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –≤—ã—à–µ)
                const mathSymbols = /[œÄŒ∏œÜœáœàœâŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ‚àà‚àâ‚äÇ‚äÉ‚à™‚à©‚àÖ‚àû‚àë‚àè‚à´‚àÇ‚àá‚Ñù‚Ñï‚Ñ§‚Ñö]/;
                const mathOperators = /[=+\-*/^_()\[\]{}]/;
                const hasMathSymbols = mathSymbols.test(trimmedCode);
                
                const wordCount = trimmedCode.split(/\s+/).filter(w => w.length > 2).length;
                const hasManyWords = wordCount > 5;
                const hasSentences = trimmedCode.match(/[.!?]\s+[–ê-–ØA-Z]/);
                
                const isFormula = hasMathSymbols || 
                                 (trimmedCode.length < 100 && 
                                  mathOperators.test(trimmedCode) && 
                                  !hasManyWords && 
                                  !hasSentences && 
                                  !hasTableMarkers &&
                                  trimmedCode.split('\n').length <= 3);
                    
                    if (isFormula) {
                        const escaped = trimmedCode
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        codeBlocks.push(`<div class="formula-block">${escaped}</div>`);
                    } else {
                        const escaped = trimmedCode
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
                    }
                    
                    // –ó–∞–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                    htmlLines[unclosedBlockStartLine] = `__CODE_BLOCK_${index}__`;
                    for (let j = unclosedBlockStartLine + 1; j < htmlLines.length; j++) {
                        if (htmlLines[j].includes('__CODE_BLOCK_')) break; // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                        htmlLines[j] = '';
                    }
                }
            }
        }
        
        html = htmlLines.join('\n');
        
        // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º inline —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤) –î–û –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        // —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–æ–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å
        
        // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (inline, –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–ï–†–ï–î –∫—É—Ä—Å–∏–≤–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        html = html.replace(/\*\*([^\n*]+?)\*\*/g, '<strong>$1</strong>');
        
        // –ö—É—Ä—Å–∏–≤ (inline, –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–û–°–õ–ï –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º [^\n*]+? —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –∑–≤–µ–∑–¥–æ—á–∫–∏
        html = html.replace(/\*([^\n*]+?)\*/g, '<em>$1</em>');
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–û–°–õ–ï —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å)
        html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        
        // –¢–∞–±–ª–∏—Ü—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
        // –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã: –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, —Å—Ç—Ä–æ–∫–∏
        // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏—â–µ—Ç: |–∑–∞–≥–æ–ª–æ–≤–æ–∫|, |---|, |–¥–∞–Ω–Ω—ã–µ|
        html = html.replace(/(\|[^\n]+\|\n\|[-\s|:]+\|\n(?:\|[^\n]+\|\n?)+)/g, (match) => {
            const lines = match.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return match;
            
            const headerLine = lines[0];
            const dataLines = lines.slice(2); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            
            // –ü–∞—Ä—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const headers = headerLine.split('|')
                .map(h => h.trim())
                .filter(h => h && !h.match(/^[-:\s]+$/)); // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
            
            if (headers.length === 0) return match;
            
            const headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            const bodyRows = dataLines.map(row => {
                const cells = row.split('|')
                    .map(c => c.trim())
                    .filter(c => c && !c.match(/^[-:\s]+$/)); // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                
                if (cells.length === 0) return '';
                return '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            }).filter(row => row).join('');
            
            if (!bodyRows) return match;
            
            return `<table class="article-table"><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
        });
        
        // Inline –∫–æ–¥ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ü–ï–†–ï–î —Å—Å—ã–ª–∫–∞–º–∏, —á—Ç–æ–±—ã —Ñ–æ—Ä–º—É–ª—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –∫–∞–∫ —Å—Å—ã–ª–∫–∏)
        const inlineCodeBlocks = [];
        html = html.replace(/`([^`]+)`/g, (match, code) => {
            const index = inlineCodeBlocks.length;
            const escaped = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            inlineCodeBlocks.push(`<code>${escaped}</code>`);
            return `__INLINE_CODE_${index}__`;
        });
        
        // –°—Å—ã–ª–∫–∏ (—Ñ–æ—Ä–º–∞—Ç markdown: [—Ç–µ–∫—Å—Ç](url))
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∫—Ä—É–≥–ª—ã—Ö —Å–∫–æ–±–∫–∞—Ö —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º URL
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
            if (!url) return match;
            
            const trimmedUrl = url.trim();
            const trimmedText = text.trim();
            
            // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º
            // –í–∞–ª–∏–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
            // - http://, https:// (—Å –¥–æ–º–µ–Ω–æ–º)
            // - mailto:email@domain.com
            // - –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏: /path, ./path, ../path
            // - –Ø–∫–æ—Ä—è: #anchor
            // - –î—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã: ftp://, file:// –∏ —Ç.–¥.
            
            let isValidUrl = false;
            
            // HTTP/HTTPS - –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω
            if (trimmedUrl.startsWith('http://') || trimmedUrl.startsWith('https://')) {
                isValidUrl = /^https?:\/\/[^\s/$.?#]+\.[^\s]+/i.test(trimmedUrl);
            }
            // mailto - –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å @
            else if (trimmedUrl.startsWith('mailto:')) {
                isValidUrl = trimmedUrl.includes('@');
            }
            // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
            else if (trimmedUrl.startsWith('/') || trimmedUrl.startsWith('./') || trimmedUrl.startsWith('../')) {
                isValidUrl = /^[./][^\s]*$/.test(trimmedUrl);
            }
            // –Ø–∫–æ—Ä—è
            else if (trimmedUrl.startsWith('#')) {
                isValidUrl = /^#[a-zA-Z0-9_-]+$/.test(trimmedUrl);
            }
            // –î—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã (ftp:, file: –∏ —Ç.–¥.)
            else if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmedUrl)) {
                isValidUrl = true;
            }
            // –ü—Ä–æ—Å—Ç—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤/—è–∫–æ—Ä—è (–±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ –±–µ–∑ /)
            else if (/^[a-zA-Z0-9._-]+$/.test(trimmedUrl)) {
                isValidUrl = true;
            }
            
            if (!isValidUrl) return match;
            
            return `<a href="${trimmedUrl}">${trimmedText}</a>`;
        });
        
        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
        html = html.replace(/^---$/gim, '<hr>');
        
        // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã –∏ —Å–ø–∏—Å–∫–∏ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫)
        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ
        const lines = html.split('\n');
        const result = [];
        let currentPara = [];
        let currentList = [];
        let currentListType = null; // 'ul' –∏–ª–∏ 'ol'
        
        function flushList() {
            if (currentList.length > 0) {
                const listTag = currentListType === 'ol' ? 'ol' : 'ul';
                result.push(`<${listTag}>${currentList.join('\n')}</${listTag}>`);
                currentList = [];
                currentListType = null;
            }
        }
        
        function flushPara() {
            if (currentPara.length > 0) {
                const paraText = currentPara.join('\n');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —É–∂–µ HTML —Ç–µ–≥–æ–º –∏–ª–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º
                if (paraText.includes('__CODE_BLOCK_') || paraText.includes('__FORMULA_BLOCK_')) {
                    // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                    const parts = paraText.split(/(__CODE_BLOCK_\d+__|__FORMULA_BLOCK_\d+__)/);
                    parts.forEach(part => {
                        if (part.match(/^__(CODE|FORMULA)_BLOCK_\d+__$/)) {
                            result.push(part);
                        } else if (part.trim()) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, –∑–∞–º–µ–Ω—è—è –∏—Ö –Ω–∞ <br>
                            const paraWithBreaks = part.replace(/\n/g, '<br>');
                            result.push(`<p>${paraWithBreaks}</p>`);
                        }
                    });
                } else if (paraText.startsWith('<') && paraText.match(/^(<h[1-6]|<ul|<ol|<li|<table|<hr|<pre|<div)/)) {
                    result.push(paraText);
                } else {
                    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ <br> –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞–º–µ–Ω—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
                    const paraWithBreaks = paraText.replace(/\n/g, '<br>');
                    result.push(`<p>${paraWithBreaks}</p>`);
                }
                currentPara = [];
            }
        }
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            
            // –ï—Å–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫
            if (!trimmed) {
                flushList();
                flushPara();
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–ø–∏—Å–∫–∞
            const listMatch = trimmed.match(/^(\d+\.|\-|\*)\s+(.+)$/);
            if (listMatch) {
                flushPara(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º
                const isOrdered = /^\d+\./.test(listMatch[1]);
                const listType = isOrdered ? 'ol' : 'ul';
                const content = listMatch[2];
                
                // –ï—Å–ª–∏ —Ç–∏–ø —Å–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è, –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ø–∏—Å–æ–∫
                if (currentListType && currentListType !== listType) {
                    flushList();
                }
                
                currentListType = listType;
                currentList.push(`<li>${content}</li>`);
                continue;
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –±–ª–æ–∫–∞ –∫–æ–¥–∞ –∏–ª–∏ —Ñ–æ—Ä–º—É–ª—ã - –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º
            if (trimmed.includes('__CODE_BLOCK_') || trimmed.includes('__FORMULA_BLOCK_')) {
                flushList();
                flushPara();
                result.push(trimmed);
                continue;
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å HTML —Ç–µ–≥–∞ - –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥
            if (trimmed.startsWith('<') && trimmed.match(/^<(h[1-6]|ul|ol|li|table|hr|pre|div)/)) {
                flushList();
                flushPara();
                result.push(trimmed);
                continue;
            }
            
            // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É (—Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏), –∞ –Ω–µ trimmed
            flushList(); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–º
            currentPara.push(line);
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ/—Å–ø–∏—Å–æ–∫
        flushList();
        flushPara();
        
        html = result.join('\n');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º inline –∫–æ–¥ (–ø–µ—Ä–µ–¥ –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞)
        inlineCodeBlocks.forEach((block, index) => {
            html = html.replace(`__INLINE_CODE_${index}__`, block);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ–π –∑–∞–º–µ–Ω—ã)
        codeBlocks.forEach((block, index) => {
            const placeholder = new RegExp(`__CODE_BLOCK_${index}__`, 'g');
            html = html.replace(placeholder, block);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞)
        formulaBlocks.forEach((block, index) => {
            const placeholder = new RegExp(`__FORMULA_BLOCK_${index}__`, 'g');
            html = html.replace(placeholder, block);
        });
        
        return html;
    }
    
    /**
     * –†–∞–∑–±–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—å—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (h2)
     * @param {string} html - HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏
     * @param {string} tocHtml - HTML —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     * @returns {string} - HTML —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     */
    function paginateArticle(html, tocHtml) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ h2 –∑–∞–≥–æ–ª–æ–≤–∫–∏
        const h2Elements = tempDiv.querySelectorAll('h2');
        
        if (h2Elements.length <= 1) {
            // –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –º–∞–ª–æ, –Ω–µ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            let result = '';
            if (tocHtml) {
                result += '<div class="article-toc-embedded">';
                result += '<h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>';
                result += tocHtml;
                result += '</div>';
                result += '<hr style="margin: 2rem 0;">';
            }
            result += html;
            return result;
        }
        
        const pages = [];
        let currentPage = [];
        let pageNumber = 1;
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        const allElements = Array.from(tempDiv.children);
        
        for (let i = 0; i < allElements.length; i++) {
            const element = allElements[i];
            
            // –ï—Å–ª–∏ —ç—Ç–æ h2 –∏ –Ω–µ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (element.tagName === 'H2' && currentPage.length > 0) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                pages.push({
                    number: pageNumber++,
                    content: currentPage.map(el => el.outerHTML).join('')
                });
                // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                currentPage = [element];
            } else {
                currentPage.push(element);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        if (currentPage.length > 0) {
            pages.push({
                number: pageNumber,
                content: currentPage.map(el => el.outerHTML).join('')
            });
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentPageNum = parseInt(urlParams.get('page')) || 1;
        const activePage = Math.max(1, Math.min(currentPageNum, pages.length));
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        let result = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        result += `<div class="article-page" data-page="${activePage}">`;
        
        // –ù–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ
        if (activePage === 1 && tocHtml) {
            result += '<div class="article-toc-embedded">';
            result += '<h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>';
            result += tocHtml;
            result += '</div>';
            result += '<hr style="margin: 2rem 0;">';
        }
        
        result += pages[activePage - 1].content;
        result += `</div>`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        result += generatePagination(pages, activePage, articleId);
        
        return result;
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
     * @param {Array} pages - –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
     * @param {number} currentPage - –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     * @param {string} articleId - ID —Å—Ç–∞—Ç—å–∏
     * @returns {string} - HTML –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     */
    function generatePagination(pages, currentPage, articleId) {
        if (!pages || pages.length === 0) {
            return '';
        }
        
        let html = '<div class="article-pagination">';
        
        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        const prevText = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
        if (currentPage > 1) {
            const prevPage = String(currentPage - 1);
            html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + prevPage + '" class="pagination-btn pagination-prev" data-link>' + prevText + '</a>';
        } else {
            html += '<span class="pagination-btn pagination-prev pagination-disabled">' + prevText + '</span>';
        }
        
        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        html += '<div class="pagination-numbers">';
        for (let i = 1; i <= pages.length; i++) {
            const pageNum = String(i);
            if (i === currentPage) {
                html += '<span class="pagination-number pagination-active">' + pageNum + '</span>';
            } else {
                html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + pageNum + '" class="pagination-number" data-link>' + pageNum + '</a>';
            }
        }
        html += '</div>';
        
        // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
        const nextText = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
        if (currentPage < pages.length) {
            const nextPage = String(currentPage + 1);
            html += '<a href="/article?id=' + encodeURIComponent(articleId) + '&page=' + nextPage + '" class="pagination-btn pagination-next" data-link>' + nextText + '</a>';
        } else {
            html += '<span class="pagination-btn pagination-next pagination-disabled">' + nextText + '</span>';
        }
        
        html += '</div>';
        
        return html;
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é
     */
    function initPagination() {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.scrollTo(0, 0);
    }
})();
</script>
